name: Build VeraCrypt for Windows

on:
  workflow_dispatch:   # allows manual triggering

jobs:
  build-windows:
    runs-on: windows-2019

    env:
      CONFIGURATION: Release

    steps:
      - name: ğŸ›ï¸ Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ğŸ’» Install dependencies via Chocolatey
        shell: powershell
        run: |
          choco install -y yasm
          choco install -y upx
          choco install -y 7zip
          choco install -y wixtoolset

      - name: ğŸ”§ Add Chocolatey-installed tools to PATH
        shell: powershell
        run: |
          $paths = @(
              "C:\ProgramData\chocolatey\bin", 
              "C:\Program Files\NASM", 
              "C:\Program Files (x86)\WiX Toolset v3.11\bin",
              "C:\ProgramData\chocolatey\lib\yasm\tools",
              "C:\ProgramData\chocolatey\lib\upx\tools",
              "C:\ProgramData\chocolatey\lib\7zip\tools"
          )
          foreach ($p in $paths) {
              if (Test-Path $p) {
                  Write-Host "Adding $p to PATH"
                  $env:PATH = "$p;$env:PATH"
              }
          }
          Write-Host "PATH updated: $env:PATH"

      - name: ğŸ”§ Install NASM (official binary)
        shell: powershell
        run: |
            $version = "2.16.01"
            $url = "https://www.nasm.us/pub/nasm/releasebuilds/$version/win64/nasm-$version-win64.zip"
            $dest = "$env:RUNNER_TEMP\nasm"
        
            Invoke-WebRequest $url -OutFile "$dest.zip"
            Expand-Archive "$dest.zip" -DestinationPath $dest
        
            echo "$dest\nasm-$version" >> $env:GITHUB_PATH

      - name: ğŸ§ª Verify dependencies
        shell: powershell
        run: |
          nasm -v
          yasm --version
          upx --version
          7z
          candle.exe -? 
          light.exe -?

      - name: ğŸ§° Setup MSBuild
        uses: microsoft/setup-msbuild@v2


      - name: ğŸ—ï¸ Build VeraCrypt Solution
        shell: cmd
        run: |
          REM Build Win32
          msbuild src\VeraCrypt.sln /p:Configuration=%CONFIGURATION% /p:Platform=Win32 /m
          REM Build x64
          msbuild src\VeraCrypt.sln /p:Configuration=%CONFIGURATION% /p:Platform=x64 /m

      - name: ğŸ“¦ Collect Build Outputs
        shell: powershell
        run: |
          $outDir = "build-artifacts"
          New-Item -ItemType Directory -Force -Path $outDir
          Copy-Item -Path src\Release\Setup\* -Destination $outDir -Recurse -Force

      - name: ğŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: VeraCrypt-Windows-Build
          path: build-artifacts/
