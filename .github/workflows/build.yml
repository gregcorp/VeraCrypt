name: Build VeraCrypt for Windows

on:
  workflow_dispatch:   # allows manual triggering

jobs:
  build-windows:
    runs-on: windows-2022

    env:
      CONFIGURATION: Release

    steps:
      - name: ğŸ›ï¸ Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ğŸ’» Install dependencies via Chocolatey
        shell: powershell
        run: |
          choco install -y yasm
          choco install -y 7zip

      - name: ğŸ”§ Download UPX
        shell: powershell
        run: |
          Invoke-WebRequest -Uri "https://github.com/upx/upx/releases/download/v3.96/upx-3.96-win32.zip" -OutFile "upx.zip"
          Expand-Archive -Path "upx.zip" -DestinationPath "upx"
          echo "PATH=$PWD\upx\upx-3.96-win32;$env:PATH" >> $env:GITHUB_ENV

      - name: ğŸ”§ Download WiX Toolset
        shell: powershell
        run: |
          Invoke-WebRequest -Uri "https://github.com/wixtoolset/wix3/releases/download/wix3141rtm/wix314.exe" -OutFile "wix.exe"
          Start-Process -FilePath "wix.exe" -ArgumentList "/quiet /norestart /log wix-install.log" -Wait
          echo "PATH=C:\Program Files (x86)\WiX Toolset v3.14\bin;$env:PATH" >> $env:GITHUB_ENV

      - name: ğŸ”§ Add Chocolatey-installed tools to PATH
        shell: powershell
        run: |
          $paths = @(
              "C:\ProgramData\chocolatey\bin", 
              "C:\Program Files\NASM", 
              "C:\Program Files (x86)\WiX Toolset v3.11\bin",
              "C:\ProgramData\chocolatey\lib\yasm\tools",
              "C:\ProgramData\chocolatey\lib\upx\tools",
              "C:\ProgramData\chocolatey\lib\7zip\tools"
          )
          foreach ($p in $paths) {
              if (Test-Path $p) {
                  Write-Host "Adding $p to PATH"
                  $env:PATH = "$p;$env:PATH"
              }
          }
          Write-Host "PATH updated: $env:PATH"

      - name: ğŸ”§ Install NASM (official binary)
        shell: powershell
        run: |
            $version = "2.16.01"
            $url = "https://www.nasm.us/pub/nasm/releasebuilds/$version/win64/nasm-$version-win64.zip"
            $dest = "$env:RUNNER_TEMP\nasm"
        
            Invoke-WebRequest $url -OutFile "$dest.zip"
            Expand-Archive "$dest.zip" -DestinationPath $dest
        
            echo "$dest\nasm-$version" >> $env:GITHUB_PATH

      - name: ğŸ”§ Disable signature verification for test build
        shell: powershell
        run: |
          $dlgcode = "src\Common\Dlgcode.c"
          (Get-Content $dlgcode) -replace 'if \(!IsOSAtLeast \(WIN_10\)\)\s*return TRUE;', 'return TRUE;' |
              Set-Content $dlgcode

      - name: ğŸ§ª Verify dependencies
        shell: powershell
        run: |
          nasm -v
          yasm --version
          upx --version
          7z
          candle.exe -? 
          light.exe -?

      - name: ğŸ§° Setup MSBuild
        uses: microsoft/setup-msbuild@v2


      - name: ğŸ—ï¸ Build VeraCrypt Solution
        shell: cmd
        run: |
          REM Build Win32
          msbuild src\VeraCrypt.sln /p:Configuration=%CONFIGURATION% /p:Platform=Win32 /m
          REM Build x64
          msbuild src\VeraCrypt.sln /p:Configuration=%CONFIGURATION% /p:Platform=x64 /m


    
      - name: ğŸ› ï¸ Build MSI Installer (x64)
        shell: cmd
        run: |
          cd src\Release\Setup Files
          build_msi_x64.bat
        

      - name: ğŸ“¦ Collect Build Outputs
        shell: powershell
        run: |
          $outDir = "build-artifacts"
          New-Item -ItemType Directory -Force -Path $outDir
          Copy-Item -Path "src\Release\Setup Files" -Destination $outDir -Recurse -Force


      - name: ğŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: VeraCrypt-Windows-Build
          path: build-artifacts/
