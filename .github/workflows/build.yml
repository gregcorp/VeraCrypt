name: Build VeraCrypt for Windows

on:
  workflow_dispatch:
    inputs:
      configuration:
        description: "Build configuration"
        required: false
        default: "Release"
      platform:
        description: "Build platform (Win32, x64, or both)"
        required: false
        default: "both"

  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build-windows:
    runs-on: windows-2022

    env:
      CONFIGURATION: ${{ github.event.inputs.configuration || 'Release' }}

    steps:
      # ------------------------------------------------------------
      # Checkout
      # ------------------------------------------------------------
      - name: üõéÔ∏è Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------------------------
      # MSBuild (VS2022 / v143)
      # ------------------------------------------------------------
      - name: üí° Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      # ------------------------------------------------------------
      # Install dependencies via Chocolatey
      # ------------------------------------------------------------
      - name: üß∞ Install build dependencies
        shell: powershell
        run: |
          choco install nasm -y
          choco install yasm -y
          choco install upx -y
          choco install 7zip -y
          choco install wixtoolset -y

      # ------------------------------------------------------------
      # Add Chocolatey + NASM to PATH (robust)
      # ------------------------------------------------------------
      - name: üîß Add Chocolatey tools and NASM to PATH
        shell: powershell
        run: |
          # 1) Always add Chocolatey shim directory
          "C:\ProgramData\chocolatey\bin" |
            Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

          # 2) Locate NASM actual install location
          $nasmExe = Get-Command nasm.exe -ErrorAction SilentlyContinue

          if (-not $nasmExe) {
            $candidates = @(
              "C:\Program Files\NASM\nasm.exe",
              "C:\Program Files (x86)\NASM\nasm.exe"
            )

            foreach ($candidate in $candidates) {
              if (Test-Path $candidate) {
                $nasmExe = $candidate
                break
              }
            }
          }

          if (-not $nasmExe) {
            Write-Error "NASM not found after Chocolatey install"
            exit 1
          }

          $nasmDir = Split-Path $nasmExe
          Write-Host "NASM found in $nasmDir"

          $nasmDir |
            Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      # ------------------------------------------------------------
      # Verify tools (PATH now active)
      # ------------------------------------------------------------
      - name: üîç Verify toolchain
        shell: powershell
        run: |
          where nasm
          nasm -v
          where upx
          where 7z
          where candle || echo "WiX candle.exe not in PATH yet (expected)"
          where light  || echo "WiX light.exe not in PATH yet (expected)"

      # ------------------------------------------------------------
      # Build Win32
      # ------------------------------------------------------------
      - name: üèóÔ∏è Build VeraCrypt (Win32)
        if: ${{ github.event.inputs.platform != 'x64' }}
        shell: cmd
        run: |
          msbuild src\VeraCrypt.sln ^
            /m ^
            /p:Configuration=%CONFIGURATION% ^
            /p:Platform=Win32

      # ------------------------------------------------------------
      # Build x64
      # ------------------------------------------------------------
      - name: üèóÔ∏è Build VeraCrypt (x64)
        if: ${{ github.event.inputs.platform != 'Win32' }}
        shell: cmd
        run: |
          msbuild src\VeraCrypt.sln ^
            /m ^
            /p:Configuration=%CONFIGURATION% ^
            /p:Platform=x64

      # ------------------------------------------------------------
      # Collect outputs
      # ------------------------------------------------------------
      - name: üì¶ Collect build artifacts
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force build-artifacts
          Get-ChildItem -Recurse src -Include *.exe,*.msi |
            Copy-Item -Destination build-artifacts -Force

      # ------------------------------------------------------------
      # Upload artifacts
      # ------------------------------------------------------------
      - name: üì§ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: VeraCrypt-Windows-${{ env.CONFIGURATION }}
          path: build-artifacts/
