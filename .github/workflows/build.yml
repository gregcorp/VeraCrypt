name: Build VeraCrypt for Windows

on:
  workflow_dispatch:   # allows manual triggering

jobs:
  build-windows:
    runs-on: windows-2019

    env:
      CONFIGURATION: Release

    steps:
      - name: üõéÔ∏è Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: üíª Install dependencies via Chocolatey
        shell: powershell
        run: |
          choco install -y nasm
          choco install -y yasm
          choco install -y upx
          choco install -y 7zip
          choco install -y wixtoolset

      - name: üîß Export tools to PATH
        shell: powershell
        run: |
          echo "C:\ProgramData\chocolatey\bin" >> $env:GITHUB_PATH
          echo "C:\ProgramData\chocolatey\lib\yasm\tools" >> $env:GITHUB_PATH
          echo "C:\ProgramData\chocolatey\lib\upx\tools" >> $env:GITHUB_PATH
          echo "C:\Program Files (x86)\WiX Toolset v3.11\bin" >> $env:GITHUB_PATH

      

      - name: üîß Add Chocolatey-installed tools to PATH
        shell: powershell
        run: |
          $paths = @(
              "C:\ProgramData\chocolatey\bin", 
              "C:\Program Files\NASM", 
              "C:\Program Files (x86)\WiX Toolset v3.11\bin",
              "C:\ProgramData\chocolatey\lib\yasm\tools",
              "C:\ProgramData\chocolatey\lib\upx\tools",
              "C:\ProgramData\chocolatey\lib\7zip\tools"
          )
          foreach ($p in $paths) {
              if (Test-Path $p) {
                  Write-Host "Adding $p to PATH"
                  $env:PATH = "$p;$env:PATH"
              }
          }
          Write-Host "PATH updated: $env:PATH"

      - name: üß™ Verify dependencies
        shell: powershell
        run: |
          nasm -v
          yasm --version
          upx --version
          7z
          candle.exe -? 
          light.exe -?

      - name: üèóÔ∏è Build VeraCrypt Solution
        shell: cmd
        run: |
          REM Build Win32
          msbuild src\VeraCrypt.sln /p:Configuration=%CONFIGURATION% /p:Platform=Win32 /m
          REM Build x64
          msbuild src\VeraCrypt.sln /p:Configuration=%CONFIGURATION% /p:Platform=x64 /m

      - name: üì¶ Collect Build Outputs
        shell: powershell
        run: |
          $outDir = "build-artifacts"
          New-Item -ItemType Directory -Force -Path $outDir
          Copy-Item -Path src\Release\Setup\* -Destination $outDir -Recurse -Force

      - name: üì§ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: VeraCrypt-Windows-Build
          path: build-artifacts/
